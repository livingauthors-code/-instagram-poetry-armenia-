name: Daily Poetry Post - Armenia

on:
  schedule:
    - cron: '0 8 * * *'  # 12:00 –ø–æ –ï—Ä–µ–≤–∞–Ω—É (UTC+4)
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    
    env:
      TZ: Asia/Yerevan  # –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ê—Ä–º–µ–Ω–∏–∏
    
    steps:
    # –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ê—Ä–º–µ–Ω–∏–∏
    - name: Set Armenian timezone
      run: |
        sudo timedatectl set-timezone Asia/Yerevan
        echo "üïí Timezone set to Armenia (Yerevan)"
        
    # –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
    - name: Checkout code
      uses: actions/checkout@v4

    # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg python3-pip imagemagick libmagickwand-dev
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ImageMagick
        sudo sed -i 's/rights="none" pattern="PDF"/rights="read | write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml
        sudo sed -i 's/rights="none" pattern="PS"/rights="read | write" pattern="PS"/' /etc/ImageMagick-6/policy.xml
        sudo sed -i 's/rights="none" pattern="EPS"/rights="read | write" pattern="EPS"/' /etc/ImageMagick-6/policy.xml
        sudo sed -i 's/rights="none" pattern="URL"/rights="read | write" pattern="URL"/' /etc/ImageMagick-6/policy.xml
        sudo sed -i 's/rights="none" pattern="HTTPS"/rights="read | write" pattern="HTTPS"/' /etc/ImageMagick-6/policy.xml
        sudo sed -i 's/rights="none" pattern="MVG"/rights="read | write" pattern="MVG"/' /etc/ImageMagick-6/policy.xml
        sudo sed -i 's/rights="none" pattern="TEXT"/rights="read | write" pattern="TEXT"/' /etc/ImageMagick-6/policy.xml
        echo "‚úÖ System dependencies installed"

     # –®–∞–≥ 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –±–∏–±–ª–∏–æ—Ç–µ–∫
    - name: Install Python dependencies
      run: |
        echo "üì¶ Installing Python dependencies directly..."
        pip install gtts==2.3.2 moviepy==1.0.3 pydub==0.25.1 selenium==4.15.0 pandas==2.1.3 opencv-python==4.8.1.78 Pillow==10.0.1 webdriver-manager==4.0.1
        echo "‚úÖ Python dependencies installed"
        
    # –®–∞–≥ 6: –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    - name: Run Instagram Poetry Bot
      env:
        INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
        INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}
      run: |
        echo "üöÄ Starting poetry bot for Armenia..."
        python src/main.py

    # –®–∞–≥ 7: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∏–¥–µ–æ (Artifacts v4)
    - name: Upload generated video
      uses: actions/upload-artifact@v4
      with:
        name: poetry-video-armenia
        path: |
          output/videos/
          output/audio/
        retention-days: 7
        if-no-files-found: warn
      
    # –®–∞–≥ 8: –û—á–∏—Å—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    - name: Cleanup
      run: |
        echo "üßπ Cleaning up temporary files"
        rm -rf output/audio/*.mp3
        echo "‚úÖ Cleanup completed"
